version: "3.7"

#################################################################
#                            DEFAULTS                           #
#################################################################
x-defaults: &defaults
  restart: always
  extra_hosts:
    - "host.docker.internal:host-gateway"

#################################################################
#                            SERVICES                           #
#################################################################
services:
  # =========================
  # =         PROXY         =
  # =========================
  traefik:
    <<: *defaults
    image: traefik:latest
    container_name: traefik
    command:
      # - "--log.level=DEBUG"
      - "--providers.file.directory=/conf"
      - "--providers.file.watch=true"
      - "--providers.docker=true"
      - "--providers.docker.network=traefik"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http.middlewares=secure-https@file"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--certificatesresolvers.le-tls.acme.tlsChallenge=true"
      - "--certificatesresolvers.le-tls.acme.email={{ general_mail_admin }}@{{ general_domain_default }}"
      - "--certificatesresolvers.le-tls.acme.storage=/letsencrypt/acme.json"
      - "--api=true"
      - "--ping.manualrouting=true"
    ports:
      - 80:80
      - 443:443
    networks:
      - traefik
    volumes:
      - ./traefik:/conf
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-cert:/letsencrypt/
    environment:
      - "TZ={{ general_timezone }}"

  traefik-forward-auth:
    <<: *defaults
    image: thomseddon/traefik-forward-auth:2
    container_name: traefik-forward-auth
    networks:
      - traefik
    environment:
      - "COOKIE_DOMAIN={{ general_domain_default }}"
      - "DEFAULT_PROVIDER=oidc"
      - "SECRET={{ app_traefik_forward_auth_secret }}"
      - "PROVIDERS_OIDC_ISSUER_URL={{ app_traefik_forward_auth_oidc_issuer_url }}"
      - "PROVIDERS_OIDC_CLIENT_ID={{ app_traefik_forward_auth_oidc_client_id }}"
      - "PROVIDERS_OIDC_CLIENT_SECRET={{ app_traefik_forward_auth_oidc_client_secret }}"

  # =========================
  # =       SYNCTHING       =
  # =========================
  syncthing:
    <<: *defaults
    image: syncthing/syncthing:1
    container_name: syncthing
    hostname: "{{ ansible_hostname }}"
    networks:
      - traefik
    ports:
      - "22000:22000"
    volumes:
      - "{{ general_path_appdata }}/syncthing/config:/var/syncthing"
      - "{{ general_path_appdata }}/syncthing/data:/data"
    environment:
      - "TZ={{ general_timezone }}"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.syncthing.entrypoints=websecure"
      - "traefik.http.routers.syncthing.rule=Host(`syncthing-{{ ansible_hostname }}.{{ general_domain_default }}`)"
      - "traefik.http.routers.syncthing.tls.certresolver=le-tls"
      - "traefik.http.services.syncthing-{{ ansible_hostname }}.loadbalancer.server.port=8384"

  # =========================
  # =      BORG SERVER      =
  # =========================
  borgserver:
    <<: *defaults
    image: nold360/borgserver:latest
    container_name: borgserver
    ports:
      - "23:22"
    volumes:
      - "{{ general_path_appdata }}/borgserver/backups:/backup"
      - "./borgserver:/sshkeys/clients:ro"
      - "borgserver-sshkeys-host:/sshkeys/host"
    environment:
      - "TZ={{ general_timezone }}"
      - "PUID={{ ansible_real_user_id }}"
      - "PGID={{ ansible_real_group_id }}"

  # =========================
  # =        LOGGING        =
  # =========================
  promtail:
    <<: *defaults
    image: grafana/promtail:2.3.0
    container_name: promtail
    command: -config.file=/etc/promtail/config.yml
    volumes:
      - ./promtail/config.yml:/etc/promtail/config.yml:ro
      - promtail-positions:/positions
      - /var/log:/var/log:ro
    environment:
      - "TZ={{ general_timezone }}"

#################################################################
#                            VOLUMES                            #
#################################################################
volumes:
  borgserver-sshkeys-host:
  promtail-positions:
  traefik-cert:

# #################################################################
# #                            NETWORKS                           #
# #################################################################
networks:
  traefik:
    name: traefik
