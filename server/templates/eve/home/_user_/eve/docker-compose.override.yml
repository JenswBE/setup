# This file contains all services generated by Ansible
# as they are marked as invalid by the JSON schema check
# for Docker Compose.

#################################################################
#                            DEFAULTS                           #
#################################################################
x-defaults: &defaults
  restart: always
  extra_hosts:
    - "host.docker.internal:host-gateway"
  deploy:
    resources:
      limits:
        cpus: "2"
        memory: 512M

#################################################################
#                            SERVICES                           #
#################################################################
services:
# Ensure to add DNS entry before bumping!
{% for year in range(2019,2023+1) %}
  nginx-tuinfeest-archive-{{ year }}:
    <<: *defaults
    image: docker.io/nginxinc/nginx-unprivileged:alpine
    container_name: "nginx-tf-archive-{{ year }}"
    user: "{{ ansible_real_user_id }}"
    networks:
      - traefik
    environment:
      TZ: "{{ general_timezone }}"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nginx-tuinfeest-archive-{{ year }}.entrypoints=websecure"
      - "traefik.http.routers.nginx-tuinfeest-archive-{{ year }}.rule=Host(`{{ year }}.{{ general_domain_tuinfeest }}`)"
      - "traefik.http.routers.nginx-tuinfeest-archive-{{ year }}.tls.certresolver=le-tls"
      - "traefik.http.services.nginx-tuinfeest-archive-{{ year }}-{{ ansible_hostname }}.loadbalancer.server.port=8080"
    volumes:
{% if year == 2021 %}
      - "./nginx/tf-2021-redirect/nginx.conf:/etc/nginx/conf.d/default.conf:ro"
{% else %}
      - "{{ general_path_appdata }}/nginx/tuinfeest-archive/{{ year }}:/usr/share/nginx/html:ro"
{% endif %}
{% endfor %}
