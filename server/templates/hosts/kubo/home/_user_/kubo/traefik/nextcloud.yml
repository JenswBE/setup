http:
  routers:
    nextcloud:
      entryPoints: ["websecure"]
      tls: { certresolver: le-tls }
      rule: Host(`nextcloud-media.{{ general_domain_default }}`)
      service: nextcloud
      middlewares:
        - nextcloud-redirect-dav
        - nextcloud-redirect-webfinger

  services:
    nextcloud:
      loadBalancer:
        servers: [{ url: "http://nextcloud" }]

  middlewares:
    nextcloud-redirect-dav:
      redirectRegex:
        regex: https://(.*)/.well-known/(card|cal)dav
        replacement: https://$1/remote.php/dav/
        permanent: true

    nextcloud-redirect-webfinger:
      redirectRegex:
        regex: https://(.*)/.well-known/webfinger
        replacement: https://$1/public.php?service=webfinger
        permanent: true
