#################################################################
#                            DEFAULTS                           #
#################################################################
x-defaults: &defaults
  restart: always
  extra_hosts:
    - "host.docker.internal:host-gateway"
  deploy:
    resources:
      limits:
        cpus: "2"
        memory: 512M

#################################################################
#                            SERVICES                           #
#################################################################
services:
  # ==========================
  # =         BLOCKY         =
  # ==========================
  blocky:
    <<: *defaults
    image: ghcr.io/0xerr0r/blocky:latest
    container_name: blocky
    ports:
      - "53:53/tcp" # DNS TCP
      - "53:53/udp" # DNS UDP
    volumes:
      - ./blocky/config.yml:/app/config.yml:ro

  blocky-pixelserv-tls: # Serves transparent pixels for Blocky
    <<: *defaults
    image: docker.io/imthai/pixelserv-tls:latest
    container_name: blocky-pixelserv-tls
    ports:
      - "80:80" # HTTP
      - "443:443" # HTTPS
    volumes:
      # MANUAL ACTION: Add /root/ca/ca.crt and /root/ca/ca.key with root only access.
      # sudo /root/ca/
      # sudo chmod 700 /root/ca/
      # sudo touch /root/ca/ca.key
      # sudo chmod 600 /root/ca/ca.key
      # sudo nano /root/ca/ca.key
      # sudo nano /root/ca/ca.crt
      # sudo chmod 600 /root/ca/ca.crt
      - /root/ca:/var/cache/pixelserv

  # ==========================
  # =    UNIFI CONTROLLER    =
  # ==========================
  unifi-controller:
    <<: *defaults
    image: docker.io/linuxserver/unifi-controller:latest
    container_name: unifi-controller
    environment:
      TZ: "{{ general_timezone }}"
      PUID: "1000"
      PGID: "1000"
      MEM_LIMIT: "1024"
      MEM_STARTUP: "1024"
    volumes:
      - "{{ general_path_appdata }}/unifi-controller/config:/config"
    ports:
      - "10001:10001/udp" # Required for AP discovery
      - "8080:8080" # Required for device communication
      - "8443:8443"
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
