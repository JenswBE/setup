- name: Setup server
  hosts: vm_host
  vars:
    playbook_supported_distros:
      - Debian

  pre_tasks:
    - name: Include init tasks
      ansible.builtin.include_tasks: "tasks/init.yml"
      tags: ["always"]

  roles:
    - role: geerlingguy.security
      become: true
      tags: ["gsecurity"]

    - role: jenswbe.basics
      tags: ["basics"]

    - role: jenswbe.automatic_updates
      tags: ["automatic_updates"]

    - role: jenswbe.nbde_server
      tags: ["nbde", "nbde_server"]

    - role: jenswbe.nbde_client
      tags: ["nbde", "nbde_client"]

    - role: jenswbe.vm_host
      tags: ["vm_host"]

    - role: community.zabbix.zabbix_agent
      zabbix_agent2: true
      zabbix_agent_server: "{{ zabbix_server_hostname }}"
      tags: ["observability", "zabbix"]

    - role: jenswbe.observability
      tags: ["observability"]

    - role: jenswbe.crowdsec
      tags: ["crowdsec"]

    # Firewall config relies on services installed by earlier roles
    - role: jenswbe.firewall
      tags: ["firewall"]

    - role: jenswbe.powersavings
      tags: ["powersavings"]

  tasks:
    - name: Install VM host specific packages
      ansible.builtin.package:
        name: intel-gpu-tools
        state: present
      tags: ["basics"]

    - name: Include host specific tasks
      ansible.builtin.include_tasks: "tasks/hosts/{{ inventory_hostname }}.yml"
      tags: ["always"]

  handlers:
    - name: GRUB regenerate
      become: true
      changed_when: true
      ansible.builtin.command: update-grub

    - name: Initramfs regenerate
      become: true
      changed_when: true
      ansible.builtin.command: update-initramfs -u

    - name: Reload systemd
      become: true
      ansible.builtin.systemd_service:
        daemon_reload: true
