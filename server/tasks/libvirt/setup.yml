- name: libvirt setup
  become: true
  tags: ["setup", "libvirt"]
  block:
    - name: Install packages
      ansible.builtin.package:
        name: "{{ item }}"
        state: present
      loop:
        - qemu-kvm # Based on https://ubuntu.com/server/docs/virtualization-libvirt
        - libvirt-daemon-system # Based on https://ubuntu.com/server/docs/virtualization-libvirt
        - python3-libvirt # Required by community.libvirt.virt_*
        - python3-lxml # Required by community.libvirt.virt_net

    - name: Get latest release of butane
      community.general.github_release:
        user: coreos
        repo: butane
        action: latest_release
      register: butane_latest
      become: false
      connection: local

    - name: Get latest butane binary
      ansible.builtin.get_url:
        url: "https://github.com/coreos/butane/releases/download/{{ butane_latest['tag'] }}/butane-x86_64-unknown-linux-gnu"
        dest: /opt/bin/butane
        group: root
        owner: root
        mode: "755"

    - name: Drop default network
      community.libvirt.virt_net:
        name: default
        state: absent

    - name: Setup networks
      include_tasks: tasks/libvirt/setup_network.yml
      vars:
        - network_name: "{{ item }}"
        - network_template_path: "libvirt/networks/{{ item }}.xml"
      loop:
        - host
        - internet
        - wireguard

    - name: Create /opt/libvirt directory
      ansible.builtin.file:
        path: /opt/libvirt
        state: directory
        owner: root
        group: root
        mode: "755"
