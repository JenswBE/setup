- name: Install, configure, and enable UFW
  become: true
  tags: ["setup", "firewall"]
  block:
    - name: UFW - Ensure is installed
      ansible.builtin.package:
        name: ufw
        state: present

    - name: UFW - Clear current firewall rules
      community.general.ufw:
        state: reset

    - name: UFW - Allow SSH
      community.general.ufw:
        rule: allow
        port: "{{ firewall_ssh_port | string }}"
        proto: tcp

    - name: UFW - Parse firewall ports
      connection: local
      register: parse_ports
      become: false
      ansible.builtin.command:
        cmd: /usr/bin/python3 helpers/parse_firewall_ports.py '{{ firewall_additional_ports | to_json }}'

    - name: UFW - Allow additional ports
      community.general.ufw:
        comment: "{{ item.comment }}"
        rule: allow
        port: "{{ item.port | string }}"
        proto: "{{ item.proto }}"
        from_ip: "{{ lookup('vars', 'network_' + item.from_network) }}"
      loop: "{{ parse_ports.stdout | from_json }}"

    - name: Setup routing for VPN
      when: firewall_vpn_routing_enabled
      block:
        - name: Enable sysctl forwarding in UFW
          ansible.builtin.lineinfile:
            path: /etc/ufw/sysctl.conf
            regexp: "^#?{{ item }}="
            line: "{{ item }}=1"
          loop:
            - net/ipv4/ip_forward
            - net/ipv6/conf/default/forwarding
            - net/ipv6/conf/all/forwarding

        - name: UFW - Allow VPN traffic forwarding
          community.general.ufw:
            comment: Allow VPN traffic forwarding
            rule: allow
            route: true
            interface_in: "{{ firewall_vpn_routing_vpn_interface }}"
            interface_out: "{{ firewall_vpn_routing_outgoing_interface }}"

        - name: UFW - Allow VPN traffic replies
          community.general.ufw:
            comment: Allow VPN traffic replies
            rule: allow
            route: true
            interface_in: "{{ firewall_vpn_routing_outgoing_interface }}"
            interface_out: "{{ firewall_vpn_routing_vpn_interface }}"

    - name: UFW - Enable firewall
      community.general.ufw:
        state: enabled
