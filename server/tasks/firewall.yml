- name: Install, configure, and enable UFW
  become: true
  tags: ["setup", "firewall"]
  block:
    - name: UFW - Ensure is installed
      ansible.builtin.package: name=ufw state=present

    - name: UFW - Clear current firewall rules
      community.general.ufw:
        state: reset

    - name: UFW - Allow SSH
      community.general.ufw:
        rule: allow
        port: "{{ firewall_ssh_port | string }}"
        proto: tcp

    - name: UFW - Parse firewall ports
      connection: local
      register: parse_ports
      become: false
      ansible.builtin.shell:
        cmd: python helpers/parse_firewall_ports.py '{{ firewall_additional_ports | to_json }}'

    - name: UFW - Allow additional ports
      community.general.ufw:
        comment: "{{ item.comment }}"
        rule: allow
        port: "{{ item.port | string }}"
        proto: "{{ item.proto }}"
        from_ip: "{{ lookup('vars', 'network_' + item.from_network) }}"
      loop: "{{ parse_ports.stdout | from_json }}"

    - name: Setup NAT routing for VPN
      when: firewall_allow_vpn_routing
      block:
        - name: Enable sysctl forwarding in UFW
          ansible.builtin.lineinfile:
            path: /etc/ufw/sysctl.conf
            regexp: "^#?{{ item }}="
            line: "{{ item }}=1"
          loop:
            - net/ipv4/ip_forward
            - net/ipv6/conf/default/forwarding
            - net/ipv6/conf/all/forwarding

        - name: Setup NAT for VPN in UFW
          ansible.builtin.blockinfile:
            path: /etc/ufw/before.rules
            block: |
              *nat
              :POSTROUTING ACCEPT [0:0]
              -A POSTROUTING -s 10.11.0.0/24 -o enp2s0 -j MASQUERADE
              COMMIT

        - name: UFW - Allow public routing
          community.general.ufw:
            comment: Allow VPN traffic forwarding
            rule: allow
            route: true
            interface_in: wg1
            interface_out: enp2s0

    - name: UFW - Enable firewall
      community.general.ufw:
        state: enabled
