- name: Install, configure, and enable FirewallD
  become: true
  tags: ["setup", "firewall"]
  block:
    - name: FirewallD - Ensure is installed
      ansible.builtin.package:
        name: firewalld
        state: present

    - name: FirewallD - Clear current firewall rules
      community.general.ufw:
        state: reset

    - name: FirewallD - Allow SSH
      community.general.ufw:
        comment: SSH
        rule: allow
        port: "{{ firewall_ssh_port | string }}"
        proto: tcp

    - name: FirewallD - Parse firewall ports
      connection: local
      register: parse_ports
      become: false
      ansible.builtin.command:
        cmd: /usr/bin/python3 helpers/parse_firewall_ports.py '{{ firewall_additional_ports | to_json }}'

    - name: FirewallD - Allow additional ports
      community.general.ufw:
        comment: "{{ item.comment }}"
        rule: allow
        port: "{{ item.port | string }}"
        proto: "{{ item.proto }}"
        from_ip: "{{ lookup('vars', 'network_' + item.from_network) }}"
      loop: "{{ parse_ports.stdout | from_json }}"

    - name: FirewallD - Enable firewall
      community.general.ufw:
        state: enabled
