- name: Setup Tang
  become: true
  tags: ["setup", "tang"]
  block:
    - name: Install Tang
      ansible.builtin.package: name=tang state=present

    - name: Ensure tangd.socket.d override directory exists
      file:
        owner: root
        group: root
        mode: "755"
        path: /etc/systemd/system/tangd.socket.d
        state: directory

    - name: Override Tang port
      register: override_tang_port
      ansible.builtin.copy:
        src: tangd.socket.override.conf
        dest: /etc/systemd/system/tangd.socket.d/override.conf
        owner: root
        group: root
        mode: "644"

    - name: Reload systemd daemon
      when: override_tang_port.changed
      systemd:
        daemon_reload: true

    - name: Enable Tang socket on boot
      ansible.builtin.systemd:
        name: tangd.socket
        enabled: true
        state: started
