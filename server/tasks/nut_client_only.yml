- name: Setup Network UPS Tools (NUT) server
  become: true
  tags: ["setup", "nut"]
  block:
    - name: Install NUT client
      ansible.builtin.package:
        state: present
        name: nut-client

    - name: Add the user 'nut' to group 'smtp-cli'
      ansible.builtin.user:
        name: nut
        groups: smtp-cli
        append: true

    - name: Copy NUT config
      ansible.builtin.include_role:
        name: jenswbe.copy_dir
      vars:
        jwcd_source_templates_dir: templates/nut/client_only/etc
        jwcd_destination_dir: /etc/nut
        jwcd_privileged: true
        jwcd_destination_mode_files: "640"
        jwcd_destination_mode_dirs: "750"
        jwcd_destination_owner: root
        jwcd_destination_group: nut

    - name: Copy upssched-cmd
      ansible.builtin.template:
        src: nut/client_only/upssched-cmd
        dest: /usr/sbin/upssched-cmd
        owner: root
        group: nut
        mode: "755"

    - name: Force restart NUT services
      ansible.builtin.service:
        name: "{{ item }}"
        state: restarted
      loop:
        - nut-client
        - nut-monitor
