- name: Include Wireguard role
  ansible.builtin.include_role:
    name: jenswbe.wireguard
    apply:
      tags:
        - wireguard
  tags: ["setup", "wireguard"]

- name: Allow both loopback and external DNS servers
  become: true
  ansible.builtin.copy:
    dest: /etc/default/resolvconf
    owner: root
    group: root
    mode: "0644"
    content: |
      TRUNCATE_NAMESERVER_LIST_AFTER_LOOPBACK_ADDRESS=no
  tags: ["setup", "dns"]
  notify: Update resolvconf

- name: Copy systemd system unit templates
  ansible.builtin.include_role:
    name: jenswbe.copy_dir
  vars:
    jwcd_source_templates_dir: "templates/hosts/{{ ansible_hostname }}/etc/systemd/system"
    jwcd_destination_dir: "/etc/systemd/system"
    jwcd_privileged: true
    jwcd_destination_mode_files: "644"
    jwcd_destination_mode_dirs: "755"
  tags: ["systemd", "mail_on_failed_unit"]

- name: Force systemd reload
  become: true
  ansible.builtin.systemd_service:
    daemon_reload: true
  tags: ["systemd", "mail_on_failed_unit"]

- name: Enable systemd timers and mounts
  become: true
  ansible.builtin.systemd_service:
    name: "{{ item }}"
    state: started
    enabled: true
  loop:
    - bjoetiek-directus-dump-db.timer
    - docker-update-containers.timer
    - goatcounter-dump-db.timer
    - isa-rclone.timer
    - keycloak-dump-db.timer
    - kristofcoenen-directus-dump-db.timer
    - miniflux-dump-db.timer
    - miniflux-reset-feed-errors.timer
    - nextcloud-calcardbackup.timer
    - nextcloud-cron.timer
    - nextcloud-db-add-missing-indices.timer
    - nextcloud-dump-db.timer
    - nextcloud-preview-generator.timer
    - nextcloud-update-apps.timer
    - paperless-dump-db.timer
    - tuinfeest-directus-dump-db.timer
    - uptime-kuma-dump-db.timer
    - vaultwarden-dump-db.timer
    - wikijs-dump-db.timer
    - wtech-directus-dump-db.timer
  tags: ["systemd"]

- name: Docker login to GHCR
  become: true
  changed_when: false
  ansible.builtin.command:
    cmd: "{{ docker_path }} login -u USERNAME -p {{ docker_ghcr_personal_access_token }} ghcr.io"
  tags: ["docker"]

- name: "Copy templates home/_user_/deploy"
  ansible.builtin.include_role:
    name: jenswbe.copy_dir
  vars:
    jwcd_source_templates_dir: "templates/hosts/{{ ansible_hostname }}/home/_user_/deploy"
    jwcd_destination_dir: "{{ ansible_user_dir }}/deploy"
    jwcd_destination_delete_extra: true
  tags: ["docker"]
