- name: Include NBDE client role
  ansible.builtin.include_role:
    name: jenswbe.nbde_client
    apply:
      tags: ["nbde", "nbde_client"]
  tags: ["nbde", "nbde_client"]

- name: Include PowerTop tasks
  ansible.builtin.include_tasks: tasks/powertop.yml
  tags: ["setup", "powertop"]

- name: Include NFS server role
  ansible.builtin.include_role:
    name: jenswbe.nfs_server
    apply:
      tags:
        - nfs
  tags: ["setup", "nfs"]

- name: Include NUT client tasks
  ansible.builtin.include_tasks: tasks/nut_client_only.yml
  tags: ["setup", "nut"]

- name: Copy systemd system unit templates
  ansible.builtin.include_role:
    name: jenswbe.copy_dir
  vars:
    jwcd_source_templates_dir: "templates/hosts/{{ ansible_hostname }}/etc/systemd/system"
    jwcd_destination_dir: "/etc/systemd/system"
    jwcd_privileged: true
    jwcd_destination_mode_files: "644"
    jwcd_destination_mode_dirs: "755"
  tags: ["systemd", "mail_on_failed_unit"]

- name: Force systemd reload
  become: true
  ansible.builtin.systemd_service:
    daemon_reload: true
  tags: ["systemd", "mail_on_failed_unit"]

- name: Enable systemd mounts and timers
  become: true
  ansible.builtin.systemd_service:
    name: "{{ item }}"
    state: started
    enabled: true
  loop:
    # Mounts
    - data-bulk.mount
    - data-important.mount
    # Timers
    - btrfs-scrub-bulk.timer
    - btrfs-scrub-important.timer
    - docker-update-containers.timer
    - github-backup.timer
    - graylog-dump-mongodb.timer
    - immich-dump-db.timer
    - nextcloud-cron.timer
    - nextcloud-db-add-missing-indices.timer
    - nextcloud-dump-db.timer
    - nextcloud-preview-generator.timer
    - nextcloud-update-apps.timer
    - unifi-dump-mongodb.timer
    - zabbix-dump-db.timer
  tags: ["systemd"]

- name: "Copy templates home/_user_/deploy"
  ansible.builtin.include_role:
    name: jenswbe.copy_dir
  vars:
    jwcd_source_templates_dir: "templates/hosts/{{ ansible_hostname }}/home/_user_/deploy"
    jwcd_destination_dir: "{{ ansible_user_dir }}/deploy"
    jwcd_destination_delete_extra: true
  tags: ["docker"]
