- name: Include logging tasks
  ansible.builtin.include_tasks: tasks/logging.yml
  tags: ["setup", "logging"]

- name: Include PowerTop tasks
  ansible.builtin.include_tasks: tasks/powertop.yml
  tags: ["setup", "powertop"]

- name: Include NFS tasks
  ansible.builtin.include_tasks: tasks/nfs.yml
  tags: ["setup", "nfs"]

- name: Include NBDE Tang tasks
  ansible.builtin.include_tasks: tasks/nbde_tang.yml
  tags: ["setup", "tang"]

- name: Include NBDE Clevis LUKS tasks
  ansible.builtin.include_tasks: tasks/nbde_clevis_luks.yml
  tags: ["setup", "clevis"]

- name: Include NUT client tasks
  ansible.builtin.include_tasks: tasks/nut_client_only.yml
  tags: ["setup", "nut"]

- name: Include libvirt tasks
  ansible.builtin.include_tasks: tasks/libvirt/setup.yml
  tags: ["setup", "libvirt"]

- name: Include Transmission tasks
  ansible.builtin.include_tasks: tasks/libvirt/transmission.yml
  tags: ["setup", "libvirt", "transmission"]

- name: Include Wireguard tasks
  ansible.builtin.include_tasks: tasks/wireguard.yml
  vars:
    wg_interface_index: "{{ item.key }}"
    wg_config: "{{ item.value }}"
  loop: "{{ app_wireguard | dict2items }}"
  tags: ["setup", "wireguard"]

- name: Copy systemd system unit templates
  ansible.builtin.include_tasks: tasks/helpers/copy_templates_folder.yml
  vars:
    templates_folder: "{{ ansible_hostname }}/etc/systemd/system"
    destination_folder: "/etc/systemd/system"
    destination_owner: root
    destination_group: root
    destination_mode_files: "600"
    destination_mode_dirs: "700"
    destination_delete_extra: false
  tags: ["systemd", "mail_on_failed_unit"]

- name: Force systemd reload
  become: true
  ansible.builtin.systemd:
    daemon_reload: true
  tags: ["systemd", "mail_on_failed_unit"]

- name: Enable systemd timers and mounts
  become: true
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: started
    enabled: true
  loop:
    - btrfs-scrub-bulk.timer
    - btrfs-scrub-important.timer
    - data-bulk.mount
    - data-important.mount
    - docker-update-containers.timer
    - github-backup.timer
    - glitchtip-dump-db.timer
    - librenms-dump-db.timer
    - miniflux-dump-db.timer
    - nextcloud-cron.timer
    - nextcloud-dump-db.timer
    - nextcloud-maps-scan-photos.timer
    - nextcloud-preview-generator.timer
    - nextcloud-update-apps.timer
  tags: ["systemd"]

- name: Copy home/_user_/kubo templates
  ansible.builtin.include_tasks: tasks/helpers/copy_templates_folder.yml
  vars:
    templates_folder: "{{ ansible_hostname }}/home/_user_/kubo"
    destination_folder: "{{ ansible_user_dir }}/{{ ansible_hostname }}"
    destination_owner: "{{ ansible_real_user_id }}"
    destination_group: "{{ ansible_real_group_id }}"
    destination_mode_files: "600"
    destination_mode_dirs: "700"
    destination_delete_extra: true
  tags: ["docker"]
