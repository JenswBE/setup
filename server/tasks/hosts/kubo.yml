- name: Setup LUKS non-root decrypt
  ansible.builtin.include_role:
    name: jenswbe.luks_decrypt
    apply:
      tags: ["luks"]
  vars:
    jwld_device_uuid: 9208facd-48eb-442a-ae86-31ce58529ced
    jwld_mapper_name: nvme1n1p1_crypt
  tags: ["always"]

- name: Configure libvirt-guests
  become: true
  ansible.builtin.lineinfile:
    path: /etc/default/libvirt-guests
    regexp: "^#?{{ item.param }}="
    line: "{{ item.param }}={{ item.value }}"
  loop:
    - param: PARALLEL_SHUTDOWN
      value: "3"
    - param: SHUTDOWN_TIMEOUT
      value: "180" # 3 mins
  notify: Reload systemd
  tags: ["setup", "libvirt"]

- name: Setup PCIE passthrough
  become: true
  tags: ["setup", "libvirt", "pcie_passthrough"]
  block:
    - name: Set kernel params
      ansible.builtin.lineinfile:
        path: /etc/default/grub
        regexp: "^#?GRUB_CMDLINE_LINUX_DEFAULT="
        line: GRUB_CMDLINE_LINUX_DEFAULT="quiet iommu=pt intel_iommu=on i915.enable_guc=0 i915.enable_fbc=0 i915.enable_gvt=1"
      notify: GRUB regenerate

    - name: Load Intel GVT-g dependencies
      ansible.builtin.copy:
        dest: /etc/modules-load.d/intel-gvt-g.conf
        owner: root
        group: root
        mode: "0644"
        content: |
          kvmgt
          mdev
          vfio-iommu-type1
      notify: Initramfs regenerate
