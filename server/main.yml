- name: Setup server
  hosts: all
  vars_files:
    - vars/basics.public.yml
    - vars/basics.secret.yml

  vars:
    golang_arch_map:
      {
        "i386": "i386",
        "x86_64": "amd64",
        "aarch64": "arm64",
        "armv6l": "armv6",
        "armv7l": "armv7",
      }

  pre_tasks:
    - name: Use of limit arg is mandatory # noqa: run-once[task]
      ansible.builtin.fail:
        msg: "You must use -l or --limit - when you really want to use all hosts, use -l 'all'"
      when: ansible_limit is not defined
      run_once: true
      tags: ["always"]

    - name: Set arch in Golang format
      ansible.builtin.set_fact:
        golang_arch: "{{ golang_arch_map[ansible_architecture] }}"
      tags: ["always"]

    - name: Load public host specific vars
      ansible.builtin.include_vars: "{{ ansible_hostname }}.public.yml"
      tags: ["always"]

    - name: Load secret host specific vars
      ansible.builtin.include_vars: "{{ ansible_hostname }}.secret.yml"
      tags: ["always"]

  roles:
    - role: geerlingguy.security
      become: true
      tags: ["setup"]

    - role: geerlingguy.docker
      become: true
      tags: ["setup"]

  tasks:
    - name: Include basic setup tasks
      ansible.builtin.include_tasks: tasks/basic_setup.yml
      tags: ["setup"]

    - name: Include firewall tasks
      ansible.builtin.include_tasks: tasks/firewall.yml
      tags: ["setup", "firewall"]

    - name: Include CrowdSec tasks
      ansible.builtin.include_tasks: tasks/crowdsec.yml
      tags: ["setup", "crowdsec"]

    - name: Include Mail on Failed Unit tasks
      ansible.builtin.include_tasks: tasks/mail_on_failed_unit.yml
      tags: ["setup", "mail_on_failed_unit"]

    - name: Include SNMPd tasks
      ansible.builtin.include_tasks: tasks/snmpd.yml
      tags: ["setup", "snmpd"]

    - name: Include host specific tasks
      ansible.builtin.include_tasks: "tasks/hosts/{{ ansible_hostname }}.yml"
      tags: ["always"]
