- hosts: all

  vars:
    is_fedora: "{{ ansible_distribution == 'Fedora' }}"
    is_ubuntu: "{{ ansible_distribution == 'Ubuntu' }}"
    supported_distros: ["Fedora", "Ubuntu"]

  vars_files:
    - vars/basics.public.yml
    - vars/basics.secret.yml

  pre_tasks:
    - name: Use of limit arg is mandatory
      ansible.builtin.fail:
        msg: "You must use -l or --limit - when you really want to use all hosts, use -l 'all'"
      when: ansible_limit is not defined
      run_once: true
      tags: ["always"]

    - name: Check if supported distro
      ansible.builtin.fail:
        msg: "Only following distro's are supported: {{ supported_distros | join(', ') }}. You are running {{ ansible_distribution }}"
      when: ansible_distribution not in supported_distros
      tags: ["always"]

    - name: Load public host specific vars
      ansible.builtin.include_vars: "{{ ansible_hostname }}.public.yml"
      tags: ["always"]

    - name: Load secret host specific vars
      ansible.builtin.include_vars: "{{ ansible_hostname }}.secret.yml"
      tags: ["always"]

  tasks:
    - ansible.builtin.include_tasks: tasks/basic_setup.yml
      tags: ["setup"]

    - ansible.builtin.include_role:
        name: geerlingguy.security
        apply:
          become: true
      tags: ["setup"]

    - ansible.builtin.include_role:
        name: geerlingguy.docker
        apply:
          become: true
      tags: ["setup"]
      when: setup_docker | bool

    - ansible.builtin.include_tasks: tasks/firewall_ubuntu.yml
      tags: ["setup", "firewall"]
      when: ansible_distribution == 'Ubuntu'

    - ansible.builtin.include_tasks: tasks/crowdsec.yml
      tags: ["setup", "crowdsec"]

    - ansible.builtin.include_tasks: tasks/mail_on_failed_unit.yml
      tags: ["setup", "mail_on_failed_unit"]

    - ansible.builtin.include_tasks: tasks/docker_logging.yml
      tags: ["setup"]
      when: setup_docker | bool

    - ansible.builtin.include_tasks: tasks/snmpd.yml
      tags: ["setup", "snmpd"]

    - ansible.builtin.include_tasks: "tasks/hosts/{{ ansible_hostname }}.yml"
      tags: ["always"]
