- name: Setup server
  hosts: all
  vars:
    playbook_name: main
    playbook_supported_distros:
      - Rocky
      - Debian

  pre_tasks:
    - name: Include init tasks
      ansible.builtin.include_tasks: "tasks/init.yml"
      tags: ["always"]

  roles:
    - role: geerlingguy.security
      become: true
      tags: ["setup", "roles"]

    - role: geerlingguy.docker
      become: true
      tags: ["setup", "roles"]
      vars:
        docker_daemon_options:
          default-address-pools:
            - base: "172.16.0.0/12"
              size: 24 # Default is /16
          icc: false
          log-driver: gelf
          log-opts:
            gelf-address: "udp://{{ app_graylog_server }}:12201"

    - role: jenswbe.basics
      tags: ["setup", "basics"]

    - role: jenswbe.firewall
      tags: ["firewall"]

  tasks:
    - name: Include firewall tasks
      ansible.builtin.include_tasks: "tasks/firewall.yml"
      tags: ["setup", "firewall"]

    - name: Include CrowdSec tasks
      ansible.builtin.include_tasks: tasks/crowdsec.yml
      tags: ["setup", "crowdsec"]

    - name: Include Zabbix agent tasks
      ansible.builtin.include_tasks: tasks/zabbix-agent.yml
      tags: ["setup", "zabbix"]

    - name: Include logging tasks
      ansible.builtin.include_tasks: tasks/logging.yml
      tags: ["setup", "logging"]

    - name: Include host specific tasks
      ansible.builtin.include_tasks: "tasks/hosts/{{ ansible_hostname }}.yml"
      tags: ["always"]

  handlers:
    - name: Update resolvconf
      become: true
      changed_when: true
      ansible.builtin.command: /usr/sbin/resolvconf -u
