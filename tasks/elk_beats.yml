- name: Install, configure, and enable Elastic Beats
  become: yes
  block:
    - name: Add Elastic signing key
      apt_key:
        url: https://artifacts.elastic.co/GPG-KEY-elasticsearch

    - name: Add Elastic apt repo
      apt_repository:
        repo: deb https://artifacts.elastic.co/packages/7.x/apt stable main

    - name: Install beats
      package:
          state: present
          name: "{{ item }}"
      with_items:
        - metricbeat

    - name: Configure Metricbeat
      template:
        src: "kubo/etc/metricbeat/metricbeat.yml"
        dest: "/etc/metricbeat/metricbeat.yml"
        owner: root
        group: root
        mode: 0600

    - name: Start and enable Metricbeat
      systemd:
        name: metricbeat
        state: restarted
        enabled: yes

    - name: Configure ElasticSearch and Kibana
      when: "ansible_hostname == app_elasticsearch_master_hostname"
      command: "metricbeat setup -E setup.kibana.password={{ app_elasticsearch_password }}"