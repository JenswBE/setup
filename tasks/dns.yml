- name: Setup NFS
  become: true
  tags: ["setup", "dns"]
  block:
    - name: Disable systemd-resolved DNSStubListener
      # Based on https://www.qualityology.com/tech/ubuntu-port-53-already-in-use-how-to-free-the-dns-port/
      ansible.builtin.lineinfile:
        dest: "/etc/systemd/resolved.conf"
        regexp: '^#?\s*DNSStubListener='
        line: "DNSStubListener=no"
        state: present
        mode: 0644
      register: disable_dns_stub_listener

    - name: Create a symbolic link
      ansible.builtin.file:
        src: /run/systemd/resolve/resolv.conf
        dest: /etc/resolv.conf
        owner: root
        group: root
        state: link
        force: true

    - name: Restart systemd-resolved
      when: disable_dns_stub_listener.changed
      systemd:
        name: "systemd-resolved"
        state: restarted
