- name: Create temporary dir
  tempfile:
    state: directory
    suffix: ".{{ ansible_hostname }}"
  register: tmp_dir
  changed_when: false

- name: Create directory structure in temporary dir
  file:
    path: "{{ tmp_dir.path }}/{{ item.path }}"
    state: directory
    owner: '{{ destination_owner }}'
    group: '{{ destination_group }}'
    mode: '{{ destination_mode_dirs }}'
  with_filetree: templates/{{ ansible_hostname }}/{{ templates_folder }}
  when: item.state == 'directory'
  changed_when: false

- name: Generate template files to temporary dir
  template:
    src: '{{ item.root }}/{{ item.path }}'
    dest: "{{ tmp_dir.path }}/{{ item.path }}"
    owner: '{{ destination_owner }}'
    group: '{{ destination_group }}'
    mode: '{{ destination_mode_files }}'
  with_filetree: templates/{{ ansible_hostname }}/{{ templates_folder }}
  when: item.state == 'file'
  changed_when: false

- name: Sync temporary dir to destination
  synchronize:
    src: "{{ tmp_dir.path }}/"
    dest: "{{ destination_folder }}"
    archive: false
    checksum: true
    group: true
    owner: true
    perms: true
    recursive: true
    delete: "{{ destination_delete_extra }}"
  delegate_to: "{{ inventory_hostname }}"
  become: true
  register: rsync_output

- name: Show rsync logs
  debug:
    var: rsync_output.stdout_lines

- name: Delete temporary folder
  file:
    path: "{{ tmp_dir.path }}"
    state: absent
  changed_when: false